#!/usr/bin/env bash
set -euo pipefail

# Keep package versions in sync.
PACKAGE_JSON_VERSION=$(jq -r .version package.json)
PACKAGE_LOCK_VERSION=$(jq -r .version package-lock.json)

if [[ "$PACKAGE_JSON_VERSION" != "$PACKAGE_LOCK_VERSION" ]]; then
  echo "Error: package.json version ($PACKAGE_JSON_VERSION) does not match" >&2
  echo "package-lock.json version ($PACKAGE_LOCK_VERSION)." >&2
  exit 1
fi

echo "Versions match: $PACKAGE_JSON_VERSION"

if ! command -v lychee >/dev/null 2>&1; then
  echo "Error: lychee is required for link checks in pre-commit." >&2
  echo "Install it: https://github.com/lycheeverse/lychee" >&2
  exit 1
fi

echo "Running lychee on staged docs..."
lychee \
  --no-progress \
  --accept 200,206,401,406,429 \
  --max-retries 2 \
  --retry-wait-time 2 \
  --exclude '^(github\+repo|s3|file)://' \
  --exclude '^https?://(localhost|127\.0\.0\.1)(:\d+)?(/|$)' \
  README.md \
  ./doc/**/*.qmd
